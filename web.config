<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <!-- Show real app errors while you finish setup; switch to custom later -->
    <httpErrors existingResponse="PassThrough" errorMode="Detailed" />

    <!-- Register the FastCGI app (per-app) -->
    <fastCgi>
      <application
        fullPath="C:\inetpub\rdportal-iisnode\upload_server_052025\venv\Scripts\python.exe"
        arguments="C:\inetpub\rdportal-iisnode\upload_server_052025\venv\Lib\site-packages\wfastcgi.py">
        <environmentVariables>
          <environmentVariable name="WSGI_HANDLER" value="rduploadservice.wsgi.application" />
          <environmentVariable name="DJANGO_SETTINGS_MODULE" value="rduploadservice.settings" />
          <environmentVariable name="PYTHONPATH" value="C:\inetpub\rdportal-iisnode\upload_server_052025" />
          <environmentVariable name="WSGI_PYTHON_HOME" value="C:\inetpub\rdportal-iisnode\upload_server_052025\venv" />
          <environmentVariable name="WSGI_LOG" value="C:\inetpub\rdportal-iisnode\Logs\wfastcgi.log" />
          <environmentVariable name="PYTHONUNBUFFERED" value="1" />
          <environmentVariable name="WSGI_RESTART_FILE_REGEX" value=".*((\.py)|(\.config))$" />
        </environmentVariables>
      </application>
    </fastCgi>

    <!-- Add our FastCGI handler. 
         requireAccess=Script keeps static files with StaticFileModule. -->
    <handlers>
      <add name="DjangoViaFastCGI"
           path="*"
           verb="*"
           modules="FastCgiModule"
           scriptProcessor="C:\inetpub\rdportal-iisnode\upload_server_052025\venv\Scripts\python.exe|C:\inetpub\rdportal-iisnode\upload_server_052025\venv\Lib\site-packages\wfastcgi.py"
           resourceType="Unspecified"
           requireAccess="Script" />
    </handlers>

    <!-- Keep static/media direct; raise upload size; allow odd URLs -->
    <security>
      <requestFiltering allowDoubleEscaping="true">
        <!-- ~2 GB (tune as needed) -->
        <requestLimits maxAllowedContentLength="2147483648" />
      </requestFiltering>
      <authentication>
        <anonymousAuthentication enabled="true" />
        <windowsAuthentication enabled="false" />
      </authentication>
    </security>
  </system.webServer>

  <!-- wfastcgi also reads these as a fallback for env vars -->
  <appSettings>
    <add key="WSGI_HANDLER" value="rduploadservice.wsgi.application" />
    <add key="DJANGO_SETTINGS_MODULE" value="rduploadservice.settings" />
    <add key="PYTHONPATH" value="C:\inetpub\rdportal-iisnode\upload_server_052025" />
    <add key="WSGI_LOG" value="C:\inetpub\rdportal-iisnode\Logs\wfastcgi.log" />
    <add key="WSGI_RESTART_FILE_REGEX" value=".*((\.py)|(\.config))$" />
  </appSettings>

  <!-- Keep light to avoid locked-section errors; set big limits at site/server if needed -->
  <system.web>
    <customErrors mode="Off" />
    <compilation debug="true" />
    <!-- If this section is locked on your server, remove it and set via IIS GUI -->
    <httpRuntime executionTimeout="1800" maxRequestLength="2097151" />
  </system.web>
</configuration>
